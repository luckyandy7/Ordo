<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ordo - Reset Password</title>
    <link rel="stylesheet" href="/Login/styles.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Cutive:wght@400&family=Inter:wght@300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <style>
      @font-face {
        font-family: "Freesentation";
        src: url("/font/Freesentation.ttf") format("truetype");
      }

      /* 비밀번호 찾기 페이지 전용 스타일 */
      .message-area {
        margin: 1.5rem 0;
        padding: 1rem;
        border-radius: var(--radius);
        text-align: center;
        font-size: 0.875rem;
        line-height: 1.5;
        min-height: 20px;
        transition: all 0.3s ease;
      }

      .message-area.success {
        background: rgba(34, 197, 94, 0.1);
        color: var(--success-color);
        border: 1px solid rgba(34, 197, 94, 0.2);
      }

      .message-area.error {
        background: rgba(239, 68, 68, 0.1);
        color: var(--error-color);
        border: 1px solid rgba(239, 68, 68, 0.2);
      }

      .temp-password {
        margin-top: 1rem;
        padding: 1rem;
        background: rgba(201, 99, 66, 0.05);
        border: 2px solid var(--copper-primary);
        border-radius: var(--radius);
        text-align: center;
      }

      .temp-password-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-bottom: 0.5rem;
      }

      .temp-password-value {
        font-size: 1.25rem;
        font-weight: bold;
        color: var(--copper-primary);
        margin: 0.5rem 0;
        letter-spacing: 2px;
        background: white;
        padding: 0.5rem 1rem;
        border-radius: var(--radius-sm);
        display: inline-block;
        border: 1px solid var(--border);
      }

      .temp-password-note {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-top: 0.5rem;
      }

      .info-note {
        font-size: 0.875rem;
        color: var(--text-muted);
      }
    </style>
</head>
<body class="loaded">
    <!-- 테마 토글 버튼 -->
    <button id="themeToggle" class="theme-toggle" title="다크모드 토글">
        <span class="theme-icon">🌙</span>
    </button>

    <div class="container">
        <!-- 왼쪽 브랜딩 섹션 -->
        <div class="branding-section">
            <div class="brand-content">
                <div class="brand-header">
                    <img src="/Login/image-8.png" alt="Ordo Logo" class="brand-logo" />
                    <h1 class="brand-title font-cutive">Ordo</h1>
                </div>
                <h2 class="brand-headline">
                    <span class="font-cutive">Forgot your password?</span><br />
                    <span class="highlight font-cutive">We'll send you a reset link</span>
                </h2>
                <p class="brand-description">
                    비밀번호를 잊어버리셨나요?<br />
                    이메일로 재설정 링크를 보내드릴게요!
                </p>
            </div>
        </div>

        <!-- 오른쪽 로그인 폼 -->
        <div class="form-section">
            <div class="login-card">
                <div class="login-header">
                    <h2 class="login-title">
                        <span class="font-cutive" style="color: #c96342">Reset Password</span>
                    </h2>
                    <p class="login-subtitle">
                        등록하신 이메일 주소를 입력하시면<br />
                        임시 비밀번호를 발급해드립니다.
                    </p>
                </div>

                <form id="forgotPasswordForm" class="login-form">
                    <div class="form-group">
                        <label for="email">이메일</label>
                        <div class="input-wrapper">
                            <span class="input-icon">📧</span>
                            <input
                                type="email"
                                id="email"
                                name="email"
                                placeholder="이메일을 입력하세요"
                                required
                            />
                        </div>
                    </div>

                    <!-- 기존 로그인 페이지의 form-options와 동일한 구조 -->
                    <div class="form-options">
                        <div class="info-note">
                            <span class="font-cutive">이메일로 재설정 링크를 받으세요</span>
                        </div>
                        <a href="/email-login" class="forgot-password">로그인으로 돌아가기</a>
                    </div>

                    <button type="submit" class="login-btn" id="submitBtn">
                        <span class="btn-text font-cutive">Send Reset Password</span>
                        <div class="btn-loader"></div>
                    </button>
                </form>

                <!-- 기존 로그인 페이지의 divider와 동일한 구조 -->
                <div class="divider">
                    <span class="font-cutive">or</span>
                </div>

                <!-- 메시지 표시 영역 (소셜 로그인 섹션 대신) -->
                <div id="message" class="message-area"></div>

                <!-- 로그인 페이지로 돌아가기 -->
                <div class="signup-section">
                    <p class="signup-text">
                        <span class="font-cutive">Remember your password?</span>
                        <a href="/email-login" class="signup-link font-cutive">Back to Sign in</a>
                    </p>
                </div>
            </div>
        </div>

        <!-- 배경 장식 -->
        <div class="bg-decoration">
            <div class="decoration-circle circle-1"></div>
            <div class="decoration-circle circle-2"></div>
            <div class="decoration-circle circle-3"></div>
        </div>
    </div>

    <!-- 로딩 오버레이 -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p class="loading-text">처리 중...</p>
    </div>

    <!-- 알림 모달 -->
    <div id="alertModal" class="alert-modal">
        <div class="alert-content">
            <div class="alert-icon">⚠️</div>
            <h3 id="alertTitle">알림</h3>
            <p id="alertMessage">메시지</p>
            <button id="alertOk" class="alert-btn">확인</button>
        </div>
    </div>

    <script>
        // 테마 관리
        let currentTheme = localStorage.getItem("theme") || "light";

        // 페이지 로드 시 테마 적용
        document.addEventListener("DOMContentLoaded", () => {
            applyTheme(currentTheme);
            initializeForgotPassword();
            initializeScrollAnimations();

            // 로딩 애니메이션
            setTimeout(() => {
                document.body.classList.remove("loading");
                document.body.classList.add("loaded");
            }, 100);
        });

        // 테마 적용 함수
        function applyTheme(theme) {
            document.documentElement.setAttribute("data-theme", theme);
            const themeIcon = document.querySelector(".theme-icon");
            if (themeIcon) {
                themeIcon.textContent = theme === "dark" ? "☀️" : "🌙";
            }
            localStorage.setItem("theme", theme);
        }

        // 스크롤 애니메이션 초기화 (기존 로그인 페이지 호환성)
        function initializeScrollAnimations() {
            // 필요시 애니메이션 로직 추가
        }

        // 알림 표시 함수
        function showAlert(title, message, callback = null) {
            const modal = document.getElementById("alertModal");
            const titleElement = document.getElementById("alertTitle");
            const messageElement = document.getElementById("alertMessage");
            const okButton = document.getElementById("alertOk");

            titleElement.textContent = title;
            messageElement.textContent = message;
            modal.classList.add("show");

            okButton.onclick = () => {
                modal.classList.remove("show");
                if (callback) callback();
            };
        }

        // 로딩 표시 함수
        function showLoading(show) {
            const loadingOverlay = document.getElementById("loadingOverlay");
            if (show) {
                loadingOverlay.classList.add("show");
            } else {
                loadingOverlay.classList.remove("show");
            }
        }

        // 비밀번호 찾기 초기화
        function initializeForgotPassword() {
            // 테마 토글
            const themeToggle = document.getElementById("themeToggle");
            if (themeToggle) {
                themeToggle.addEventListener("click", () => {
                    currentTheme = currentTheme === "light" ? "dark" : "light";
                    applyTheme(currentTheme);
                });
            }

            // 폼 제출
            const forgotForm = document.getElementById("forgotPasswordForm");
            if (forgotForm) {
                forgotForm.addEventListener("submit", handleForgotPassword);
            }

            // 입력 필드 포커스 효과
            const inputs = document.querySelectorAll("input");
            inputs.forEach((input) => {
                input.addEventListener("focus", () => {
                    input.parentElement.classList.add("focused");
                });

                input.addEventListener("blur", () => {
                    if (!input.value) {
                        input.parentElement.classList.remove("focused");
                    }
                });

                // 이메일 유효성 검사
                if (input.type === "email") {
                    input.addEventListener("input", (e) => {
                        const email = e.target.value;
                        const isValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
                        
                        if (email && !isValid) {
                            e.target.style.borderColor = 'var(--error-color)';
                        } else {
                            e.target.style.borderColor = 'var(--border)';
                        }
                    });
                }
            });
        }

        // 비밀번호 찾기 처리
        async function handleForgotPassword(e) {
            e.preventDefault();

            const email = document.getElementById("email").value.trim();
            const messageElement = document.getElementById("message");
            const submitBtn = document.getElementById("submitBtn");
            const btnText = submitBtn.querySelector('.btn-text');

            // 유효성 검사
            if (!email) {
                showMessage('error', '이메일을 입력해주세요.');
                return;
            }

            // 이메일 형식 검사
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showMessage('error', '올바른 이메일 형식을 입력해주세요.');
                return;
            }

            // 로딩 상태
            submitBtn.disabled = true;
            submitBtn.classList.add('loading');
            btnText.textContent = 'Sending...';
            showLoading(true);
            clearMessage();

            try {
                console.log('비밀번호 찾기 요청:', email);
                
                const response = await fetch('/api/forgot-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email })
                });
                
                console.log('응답 상태:', response.status);
                const data = await response.json();
                console.log('응답 데이터:', data);
                
                if (response.ok) {
                    if (data.resetUrl && data.isLocalOnly) {
                        // 개발 환경에서 이메일 발송 실패 시 링크 제공
                        showMessage('success', `
                            <div>⚠️ ${data.message}</div>
                            <div class="temp-password">
                                <div class="temp-password-label">개발 모드 - 비밀번호 재설정 링크</div>
                                <div style="margin: 0.5rem 0;">
                                    <a href="${data.resetUrl}" 
                                       style="color: var(--copper-primary); text-decoration: underline; font-weight: bold;"
                                       target="_blank">
                                        🔐 비밀번호 재설정하기 ➜
                                    </a>
                                </div>
                                <div class="temp-password-note">
                                    ⏰ 링크는 1시간 동안 유효합니다
                                </div>
                            </div>
                        `);
                    } else {
                        // 정상적인 이메일 발송
                        showMessage('success', `
                            <div>✅ ${data.message}</div>
                            <div style="margin-top: 1rem; font-size: 0.875rem; color: var(--text-muted);">
                                📧 메일함(스팸함 포함)을 확인해주세요<br>
                                링크는 <strong>1시간 동안만</strong> 유효합니다
                            </div>
                        `);

                        // 10초 후 로그인 페이지로 이동 제안
                        setTimeout(() => {
                            showAlert(
                                "이메일 확인",
                                "메일함을 확인하신 후 로그인 페이지로 돌아가시겠습니까?",
                                () => {
                                    window.location.href = '/email-login';
                                }
                            );
                        }, 10000);
                    }
                } else {
                    showMessage('error', data.message || '알 수 없는 오류가 발생했습니다.');
                }
            } catch (error) {
                console.error('비밀번호 찾기 오류:', error);
                showMessage('error', '서버 연결에 실패했습니다. 잠시 후 다시 시도해주세요.');
            } finally {
                // 로딩 상태 해제
                submitBtn.disabled = false;
                submitBtn.classList.remove('loading');
                btnText.textContent = 'Send Reset Password';
                showLoading(false);
            }
        }

        // 메시지 표시 함수
        function showMessage(type, message) {
            const messageElement = document.getElementById("message");
            messageElement.className = `message-area ${type}`;
            messageElement.innerHTML = message;
        }

        // 메시지 초기화 함수
        function clearMessage() {
            const messageElement = document.getElementById("message");
            messageElement.className = 'message-area';
            messageElement.innerHTML = '';
        }
    </script>
</body>
</html> 