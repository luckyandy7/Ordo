<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ordo - Reset Password</title>
    <link rel="stylesheet" href="/Login/styles.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Cutive:wght@400&family=Inter:wght@300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <style>
      @font-face {
        font-family: "Freesentation";
        src: url("/font/Freesentation.ttf") format("truetype");
      }

      /* 비밀번호 재설정 페이지 전용 스타일 */
      .message-area {
        margin: 1.5rem 0;
        padding: 1rem;
        border-radius: var(--radius);
        text-align: center;
        font-size: 0.875rem;
        line-height: 1.5;
        min-height: 20px;
        transition: all 0.3s ease;
      }

      .message-area.success {
        background: rgba(34, 197, 94, 0.1);
        color: var(--success-color);
        border: 1px solid rgba(34, 197, 94, 0.2);
      }

      .message-area.error {
        background: rgba(239, 68, 68, 0.1);
        color: var(--error-color);
        border: 1px solid rgba(239, 68, 68, 0.2);
      }

      .password-requirements {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-top: 0.5rem;
        line-height: 1.4;
      }

      .strength-indicator {
        height: 4px;
        background: var(--border);
        border-radius: 2px;
        margin-top: 0.5rem;
        overflow: hidden;
      }

      .strength-bar {
        height: 100%;
        transition: all 0.3s ease;
        border-radius: 2px;
      }

      .strength-weak { background: #ef4444; width: 33%; }
      .strength-medium { background: #f59e0b; width: 66%; }
      .strength-strong { background: #22c55e; width: 100%; }
    </style>
  </head>
  <body class="loaded">
    <div class="container">
      <!-- 테마 토글 버튼 -->
      <button id="themeToggle" class="theme-toggle" title="다크모드 토글">
        <span class="theme-icon">🌙</span>
      </button>

      <!-- 왼쪽 브랜딩 섹션 -->
      <div class="branding-section">
        <div class="brand-content">
          <div class="brand-header">
            <img src="/Login/image-8.png" alt="Ordo Logo" class="brand-logo" />
            <h1 class="brand-title font-cutive">Ordo</h1>
          </div>
          <h2 class="brand-headline">
            <span class="font-cutive">Create a new password</span><br />
            <span class="highlight font-cutive">Secure your account</span>
          </h2>
          <p class="brand-description">
            새로운 비밀번호를 설정하여<br />
            계정을 안전하게 보호하세요
          </p>
        </div>
      </div>

      <!-- 오른쪽 로그인 폼 -->
      <div class="form-section">
        <div class="login-card">
          <div class="login-header">
            <h2 class="login-title">
              <span class="font-cutive" style="color: #c96342">새 비밀번호 설정</span>
            </h2>
            <p class="login-subtitle">
              안전한 비밀번호를 생성하여<br />
              계정을 보호해주세요
            </p>
          </div>

          <form id="resetPasswordForm" class="login-form">
            <div class="form-group">
              <label for="newPassword">새 비밀번호</label>
              <div class="input-wrapper">
                <span class="input-icon">🔒</span>
                <input
                  type="password"
                  id="newPassword"
                  name="newPassword"
                  placeholder="새 비밀번호를 입력하세요"
                  required
                />
                <button
                  type="button"
                  class="password-toggle"
                  id="passwordToggle1"
                >
                  👁️
                </button>
              </div>
              <div class="password-requirements">
                8자 이상, 대소문자, 숫자, 특수문자 포함 권장
              </div>
              <div class="strength-indicator">
                <div class="strength-bar" id="strengthBar"></div>
              </div>
            </div>

            <div class="form-group">
              <label for="confirmPassword">비밀번호 확인</label>
              <div class="input-wrapper">
                <span class="input-icon">🔒</span>
                <input
                  type="password"
                  id="confirmPassword"
                  name="confirmPassword"
                  placeholder="비밀번호를 다시 입력하세요"
                  required
                />
                <button
                  type="button"
                  class="password-toggle"
                  id="passwordToggle2"
                >
                  👁️
                </button>
              </div>
            </div>

            <div class="form-options">
              <div class="info-note">
                <span class="font-cutive">안전한 비밀번호로 설정하세요</span>
              </div>
            </div>

            <button type="submit" class="login-btn" id="submitBtn">
              <span class="btn-text font-cutive">Set New Password</span>
              <div class="btn-loader"></div>
            </button>
          </form>

          <!-- 메시지 표시 영역 -->
          <div id="message" class="message-area"></div>

          <!-- 로그인 페이지로 돌아가기 -->
          <div class="signup-section">
            <p class="signup-text">
              <span class="font-cutive">Password reset successful?</span>
              <a href="/email-login" class="signup-link font-cutive">Back to Sign in</a>
            </p>
          </div>
        </div>
      </div>

      <!-- 배경 장식 -->
      <div class="bg-decoration">
        <div class="decoration-circle circle-1"></div>
        <div class="decoration-circle circle-2"></div>
        <div class="decoration-circle circle-3"></div>
      </div>
    </div>

    <!-- 로딩 오버레이 -->
    <div id="loadingOverlay" class="loading-overlay">
      <div class="loading-spinner"></div>
      <p class="loading-text">처리 중...</p>
    </div>

    <!-- 알림 모달 -->
    <div id="alertModal" class="alert-modal">
      <div class="alert-content">
        <div class="alert-icon">⚠️</div>
        <h3 id="alertTitle">알림</h3>
        <p id="alertMessage">메시지</p>
        <button id="alertOk" class="alert-btn">확인</button>
      </div>
    </div>

    <script>
      // 테마 관리
      let currentTheme = localStorage.getItem("theme") || "light";

      // URL에서 토큰 추출
      const urlParams = new URLSearchParams(window.location.search);
      const resetToken = urlParams.get('token');

      // 페이지 로드 시 테마 적용
      document.addEventListener("DOMContentLoaded", () => {
        applyTheme(currentTheme);
        initializeResetPassword();
        initializeScrollAnimations();

        // 토큰 검증
        if (!resetToken) {
          showAlert("오류", "유효하지 않은 재설정 링크입니다.", () => {
            window.location.href = '/email-login';
          });
          return;
        }

        // 로딩 애니메이션
        setTimeout(() => {
          document.body.classList.remove("loading");
          document.body.classList.add("loaded");
        }, 100);
      });

      // 테마 적용 함수
      function applyTheme(theme) {
        document.documentElement.setAttribute("data-theme", theme);
        const themeIcon = document.querySelector(".theme-icon");
        if (themeIcon) {
          themeIcon.textContent = theme === "dark" ? "☀️" : "🌙";
        }
        localStorage.setItem("theme", theme);
      }

      // 스크롤 애니메이션 초기화
      function initializeScrollAnimations() {
        // 필요시 애니메이션 로직 추가
      }

      // 알림 표시 함수
      function showAlert(title, message, callback = null) {
        const modal = document.getElementById("alertModal");
        const titleElement = document.getElementById("alertTitle");
        const messageElement = document.getElementById("alertMessage");
        const okButton = document.getElementById("alertOk");

        titleElement.textContent = title;
        messageElement.textContent = message;
        modal.classList.add("show");

        okButton.onclick = () => {
          modal.classList.remove("show");
          if (callback) callback();
        };
      }

      // 로딩 표시 함수
      function showLoading(show) {
        const loadingOverlay = document.getElementById("loadingOverlay");
        if (show) {
          loadingOverlay.classList.add("show");
        } else {
          loadingOverlay.classList.remove("show");
        }
      }

      // 비밀번호 강도 체크
      function checkPasswordStrength(password) {
        let strength = 0;
        
        // 길이 체크
        if (password.length >= 8) strength++;
        if (password.length >= 12) strength++;
        
        // 복잡도 체크
        if (/[a-z]/.test(password)) strength++; // 소문자
        if (/[A-Z]/.test(password)) strength++; // 대문자
        if (/[0-9]/.test(password)) strength++; // 숫자
        if (/[^A-Za-z0-9]/.test(password)) strength++; // 특수문자
        
        return Math.min(strength, 6);
      }

      // 비밀번호 재설정 초기화
      function initializeResetPassword() {
        // 테마 토글
        const themeToggle = document.getElementById("themeToggle");
        if (themeToggle) {
          themeToggle.addEventListener("click", () => {
            currentTheme = currentTheme === "light" ? "dark" : "light";
            applyTheme(currentTheme);
          });
        }

        // 비밀번호 표시/숨김
        const passwordToggle1 = document.getElementById("passwordToggle1");
        const passwordToggle2 = document.getElementById("passwordToggle2");
        const passwordInput1 = document.getElementById("newPassword");
        const passwordInput2 = document.getElementById("confirmPassword");

        if (passwordToggle1 && passwordInput1) {
          passwordToggle1.addEventListener("click", () => {
            const type = passwordInput1.getAttribute("type") === "password" ? "text" : "password";
            passwordInput1.setAttribute("type", type);
            passwordToggle1.textContent = type === "password" ? "👁️" : "🙈";
          });
        }

        if (passwordToggle2 && passwordInput2) {
          passwordToggle2.addEventListener("click", () => {
            const type = passwordInput2.getAttribute("type") === "password" ? "text" : "password";
            passwordInput2.setAttribute("type", type);
            passwordToggle2.textContent = type === "password" ? "👁️" : "🙈";
          });
        }

        // 비밀번호 강도 인디케이터
        const strengthBar = document.getElementById("strengthBar");
        if (passwordInput1 && strengthBar) {
          passwordInput1.addEventListener("input", (e) => {
            const password = e.target.value;
            const strength = checkPasswordStrength(password);
            
            strengthBar.className = "strength-bar";
            if (strength <= 2) {
              strengthBar.classList.add("strength-weak");
            } else if (strength <= 4) {
              strengthBar.classList.add("strength-medium");
            } else {
              strengthBar.classList.add("strength-strong");
            }
          });
        }

        // 폼 제출
        const resetForm = document.getElementById("resetPasswordForm");
        if (resetForm) {
          resetForm.addEventListener("submit", handlePasswordReset);
        }

        // 입력 필드 포커스 효과
        const inputs = document.querySelectorAll("input");
        inputs.forEach((input) => {
          input.addEventListener("focus", () => {
            input.parentElement.classList.add("focused");
          });

          input.addEventListener("blur", () => {
            if (!input.value) {
              input.parentElement.classList.remove("focused");
            }
          });
        });
      }

      // 비밀번호 재설정 처리
      async function handlePasswordReset(e) {
        e.preventDefault();

        const newPassword = document.getElementById("newPassword").value;
        const confirmPassword = document.getElementById("confirmPassword").value;
        const submitBtn = document.getElementById("submitBtn");
        const btnText = submitBtn.querySelector('.btn-text');

        // 유효성 검사
        if (!newPassword || !confirmPassword) {
          showMessage('error', '모든 필드를 입력해주세요.');
          return;
        }

        if (newPassword !== confirmPassword) {
          showMessage('error', '비밀번호가 일치하지 않습니다.');
          return;
        }

        if (newPassword.length < 8) {
          showMessage('error', '비밀번호는 8자 이상이어야 합니다.');
          return;
        }

        // 로딩 상태
        submitBtn.disabled = true;
        submitBtn.classList.add('loading');
        btnText.textContent = 'Setting...';
        showLoading(true);
        clearMessage();

        try {
          const response = await fetch('/api/reset-password', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
              token: resetToken,
              newPassword: newPassword 
            })
          });
          
          const data = await response.json();
          
          if (response.ok) {
            showAlert(
              "성공",
              "비밀번호가 성공적으로 변경되었습니다. 새 비밀번호로 로그인해주세요.",
              () => {
                window.location.href = '/email-login';
              }
            );
          } else {
            showMessage('error', data.message || '비밀번호 변경에 실패했습니다.');
          }
        } catch (error) {
          console.error('비밀번호 재설정 오류:', error);
          showMessage('error', '서버 연결에 실패했습니다. 잠시 후 다시 시도해주세요.');
        } finally {
          // 로딩 상태 해제
          submitBtn.disabled = false;
          submitBtn.classList.remove('loading');
          btnText.textContent = 'Set New Password';
          showLoading(false);
        }
      }

      // 메시지 표시 함수
      function showMessage(type, message) {
        const messageElement = document.getElementById("message");
        messageElement.className = `message-area ${type}`;
        messageElement.innerHTML = message;
      }

      // 메시지 초기화 함수
      function clearMessage() {
        const messageElement = document.getElementById("message");
        messageElement.className = 'message-area';
        messageElement.innerHTML = '';
      }
    </script>
  </body>
</html> 