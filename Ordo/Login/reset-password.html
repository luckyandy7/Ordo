<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ordo - Reset Password</title>
    <link rel="stylesheet" href="/Login/styles.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Cutive:wght@400&family=Inter:wght@300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <style>
      @font-face {
        font-family: "Freesentation";
        src: url("/font/Freesentation.ttf") format("truetype");
      }

      /* ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼ */
      .message-area {
        margin: 1.5rem 0;
        padding: 1rem;
        border-radius: var(--radius);
        text-align: center;
        font-size: 0.875rem;
        line-height: 1.5;
        min-height: 20px;
        transition: all 0.3s ease;
      }

      .message-area.success {
        background: rgba(34, 197, 94, 0.1);
        color: var(--success-color);
        border: 1px solid rgba(34, 197, 94, 0.2);
      }

      .message-area.error {
        background: rgba(239, 68, 68, 0.1);
        color: var(--error-color);
        border: 1px solid rgba(239, 68, 68, 0.2);
      }

      .password-requirements {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-top: 0.5rem;
        line-height: 1.4;
      }

      .strength-indicator {
        height: 4px;
        background: var(--border);
        border-radius: 2px;
        margin-top: 0.5rem;
        overflow: hidden;
      }

      .strength-bar {
        height: 100%;
        transition: all 0.3s ease;
        border-radius: 2px;
      }

      .strength-weak { background: #ef4444; width: 33%; }
      .strength-medium { background: #f59e0b; width: 66%; }
      .strength-strong { background: #22c55e; width: 100%; }
    </style>
  </head>
  <body class="loaded">
    <div class="container">
      <!-- í…Œë§ˆ í† ê¸€ ë²„íŠ¼ -->
      <button id="themeToggle" class="theme-toggle" title="ë‹¤í¬ëª¨ë“œ í† ê¸€">
        <span class="theme-icon">ğŸŒ™</span>
      </button>

      <!-- ì™¼ìª½ ë¸Œëœë”© ì„¹ì…˜ -->
      <div class="branding-section">
        <div class="brand-content">
          <div class="brand-header">
            <img src="/Login/image-8.png" alt="Ordo Logo" class="brand-logo" />
            <h1 class="brand-title font-cutive">Ordo</h1>
          </div>
          <h2 class="brand-headline">
            <span class="font-cutive">Create a new password</span><br />
            <span class="highlight font-cutive">Secure your account</span>
          </h2>
          <p class="brand-description">
            ìƒˆë¡œìš´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•˜ì—¬<br />
            ê³„ì •ì„ ì•ˆì „í•˜ê²Œ ë³´í˜¸í•˜ì„¸ìš”
          </p>
        </div>
      </div>

      <!-- ì˜¤ë¥¸ìª½ ë¡œê·¸ì¸ í¼ -->
      <div class="form-section">
        <div class="login-card">
          <div class="login-header">
            <h2 class="login-title">
              <span class="font-cutive" style="color: #c96342">ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì„¤ì •</span>
            </h2>
            <p class="login-subtitle">
              ì•ˆì „í•œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ìƒì„±í•˜ì—¬<br />
              ê³„ì •ì„ ë³´í˜¸í•´ì£¼ì„¸ìš”
            </p>
          </div>

          <form id="resetPasswordForm" class="login-form">
            <div class="form-group">
              <label for="newPassword">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
              <div class="input-wrapper">
                <span class="input-icon">ğŸ”’</span>
                <input
                  type="password"
                  id="newPassword"
                  name="newPassword"
                  placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                  required
                />
                <button
                  type="button"
                  class="password-toggle"
                  id="passwordToggle1"
                >
                  ğŸ‘ï¸
                </button>
              </div>
              <div class="password-requirements">
                8ì ì´ìƒ, ëŒ€ì†Œë¬¸ì, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì í¬í•¨ ê¶Œì¥
              </div>
              <div class="strength-indicator">
                <div class="strength-bar" id="strengthBar"></div>
              </div>
            </div>

            <div class="form-group">
              <label for="confirmPassword">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
              <div class="input-wrapper">
                <span class="input-icon">ğŸ”’</span>
                <input
                  type="password"
                  id="confirmPassword"
                  name="confirmPassword"
                  placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”"
                  required
                />
                <button
                  type="button"
                  class="password-toggle"
                  id="passwordToggle2"
                >
                  ğŸ‘ï¸
                </button>
              </div>
            </div>

            <div class="form-options">
              <div class="info-note">
                <span class="font-cutive">ì•ˆì „í•œ ë¹„ë°€ë²ˆí˜¸ë¡œ ì„¤ì •í•˜ì„¸ìš”</span>
              </div>
            </div>

            <button type="submit" class="login-btn" id="submitBtn">
              <span class="btn-text font-cutive">Set New Password</span>
              <div class="btn-loader"></div>
            </button>
          </form>

          <!-- ë©”ì‹œì§€ í‘œì‹œ ì˜ì—­ -->
          <div id="message" class="message-area"></div>

          <!-- ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸° -->
          <div class="signup-section">
            <p class="signup-text">
              <span class="font-cutive">Password reset successful?</span>
              <a href="/email-login" class="signup-link font-cutive">Back to Sign in</a>
            </p>
          </div>
        </div>
      </div>

      <!-- ë°°ê²½ ì¥ì‹ -->
      <div class="bg-decoration">
        <div class="decoration-circle circle-1"></div>
        <div class="decoration-circle circle-2"></div>
        <div class="decoration-circle circle-3"></div>
      </div>
    </div>

    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div id="loadingOverlay" class="loading-overlay">
      <div class="loading-spinner"></div>
      <p class="loading-text">ì²˜ë¦¬ ì¤‘...</p>
    </div>

    <!-- ì•Œë¦¼ ëª¨ë‹¬ -->
    <div id="alertModal" class="alert-modal">
      <div class="alert-content">
        <div class="alert-icon">âš ï¸</div>
        <h3 id="alertTitle">ì•Œë¦¼</h3>
        <p id="alertMessage">ë©”ì‹œì§€</p>
        <button id="alertOk" class="alert-btn">í™•ì¸</button>
      </div>
    </div>

    <script>
      // í…Œë§ˆ ê´€ë¦¬
      let currentTheme = localStorage.getItem("theme") || "light";

      // URLì—ì„œ í† í° ì¶”ì¶œ
      const urlParams = new URLSearchParams(window.location.search);
      const resetToken = urlParams.get('token');

      // í˜ì´ì§€ ë¡œë“œ ì‹œ í…Œë§ˆ ì ìš©
      document.addEventListener("DOMContentLoaded", () => {
        applyTheme(currentTheme);
        initializeResetPassword();
        initializeScrollAnimations();

        // í† í° ê²€ì¦
        if (!resetToken) {
          showAlert("ì˜¤ë¥˜", "ìœ íš¨í•˜ì§€ ì•Šì€ ì¬ì„¤ì • ë§í¬ì…ë‹ˆë‹¤.", () => {
            window.location.href = '/email-login';
          });
          return;
        }

        // ë¡œë”© ì• ë‹ˆë©”ì´ì…˜
        setTimeout(() => {
          document.body.classList.remove("loading");
          document.body.classList.add("loaded");
        }, 100);
      });

      // í…Œë§ˆ ì ìš© í•¨ìˆ˜
      function applyTheme(theme) {
        document.documentElement.setAttribute("data-theme", theme);
        const themeIcon = document.querySelector(".theme-icon");
        if (themeIcon) {
          themeIcon.textContent = theme === "dark" ? "â˜€ï¸" : "ğŸŒ™";
        }
        localStorage.setItem("theme", theme);
      }

      // ìŠ¤í¬ë¡¤ ì• ë‹ˆë©”ì´ì…˜ ì´ˆê¸°í™”
      function initializeScrollAnimations() {
        // í•„ìš”ì‹œ ì• ë‹ˆë©”ì´ì…˜ ë¡œì§ ì¶”ê°€
      }

      // ì•Œë¦¼ í‘œì‹œ í•¨ìˆ˜
      function showAlert(title, message, callback = null) {
        const modal = document.getElementById("alertModal");
        const titleElement = document.getElementById("alertTitle");
        const messageElement = document.getElementById("alertMessage");
        const okButton = document.getElementById("alertOk");

        titleElement.textContent = title;
        messageElement.textContent = message;
        modal.classList.add("show");

        okButton.onclick = () => {
          modal.classList.remove("show");
          if (callback) callback();
        };
      }

      // ë¡œë”© í‘œì‹œ í•¨ìˆ˜
      function showLoading(show) {
        const loadingOverlay = document.getElementById("loadingOverlay");
        if (show) {
          loadingOverlay.classList.add("show");
        } else {
          loadingOverlay.classList.remove("show");
        }
      }

      // ë¹„ë°€ë²ˆí˜¸ ê°•ë„ ì²´í¬
      function checkPasswordStrength(password) {
        let strength = 0;
        
        // ê¸¸ì´ ì²´í¬
        if (password.length >= 8) strength++;
        if (password.length >= 12) strength++;
        
        // ë³µì¡ë„ ì²´í¬
        if (/[a-z]/.test(password)) strength++; // ì†Œë¬¸ì
        if (/[A-Z]/.test(password)) strength++; // ëŒ€ë¬¸ì
        if (/[0-9]/.test(password)) strength++; // ìˆ«ì
        if (/[^A-Za-z0-9]/.test(password)) strength++; // íŠ¹ìˆ˜ë¬¸ì
        
        return Math.min(strength, 6);
      }

      // ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì´ˆê¸°í™”
      function initializeResetPassword() {
        // í…Œë§ˆ í† ê¸€
        const themeToggle = document.getElementById("themeToggle");
        if (themeToggle) {
          themeToggle.addEventListener("click", () => {
            currentTheme = currentTheme === "light" ? "dark" : "light";
            applyTheme(currentTheme);
          });
        }

        // ë¹„ë°€ë²ˆí˜¸ í‘œì‹œ/ìˆ¨ê¹€
        const passwordToggle1 = document.getElementById("passwordToggle1");
        const passwordToggle2 = document.getElementById("passwordToggle2");
        const passwordInput1 = document.getElementById("newPassword");
        const passwordInput2 = document.getElementById("confirmPassword");

        if (passwordToggle1 && passwordInput1) {
          passwordToggle1.addEventListener("click", () => {
            const type = passwordInput1.getAttribute("type") === "password" ? "text" : "password";
            passwordInput1.setAttribute("type", type);
            passwordToggle1.textContent = type === "password" ? "ğŸ‘ï¸" : "ğŸ™ˆ";
          });
        }

        if (passwordToggle2 && passwordInput2) {
          passwordToggle2.addEventListener("click", () => {
            const type = passwordInput2.getAttribute("type") === "password" ? "text" : "password";
            passwordInput2.setAttribute("type", type);
            passwordToggle2.textContent = type === "password" ? "ğŸ‘ï¸" : "ğŸ™ˆ";
          });
        }

        // ë¹„ë°€ë²ˆí˜¸ ê°•ë„ ì¸ë””ì¼€ì´í„°
        const strengthBar = document.getElementById("strengthBar");
        if (passwordInput1 && strengthBar) {
          passwordInput1.addEventListener("input", (e) => {
            const password = e.target.value;
            const strength = checkPasswordStrength(password);
            
            strengthBar.className = "strength-bar";
            if (strength <= 2) {
              strengthBar.classList.add("strength-weak");
            } else if (strength <= 4) {
              strengthBar.classList.add("strength-medium");
            } else {
              strengthBar.classList.add("strength-strong");
            }
          });
        }

        // í¼ ì œì¶œ
        const resetForm = document.getElementById("resetPasswordForm");
        if (resetForm) {
          resetForm.addEventListener("submit", handlePasswordReset);
        }

        // ì…ë ¥ í•„ë“œ í¬ì»¤ìŠ¤ íš¨ê³¼
        const inputs = document.querySelectorAll("input");
        inputs.forEach((input) => {
          input.addEventListener("focus", () => {
            input.parentElement.classList.add("focused");
          });

          input.addEventListener("blur", () => {
            if (!input.value) {
              input.parentElement.classList.remove("focused");
            }
          });
        });
      }

      // ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì²˜ë¦¬
      async function handlePasswordReset(e) {
        e.preventDefault();

        const newPassword = document.getElementById("newPassword").value;
        const confirmPassword = document.getElementById("confirmPassword").value;
        const submitBtn = document.getElementById("submitBtn");
        const btnText = submitBtn.querySelector('.btn-text');

        // ìœ íš¨ì„± ê²€ì‚¬
        if (!newPassword || !confirmPassword) {
          showMessage('error', 'ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }

        if (newPassword !== confirmPassword) {
          showMessage('error', 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
          return;
        }

        if (newPassword.length < 8) {
          showMessage('error', 'ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
          return;
        }

        // ë¡œë”© ìƒíƒœ
        submitBtn.disabled = true;
        submitBtn.classList.add('loading');
        btnText.textContent = 'Setting...';
        showLoading(true);
        clearMessage();

        try {
          const response = await fetch('/api/reset-password', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
              token: resetToken,
              newPassword: newPassword 
            })
          });
          
          const data = await response.json();
          
          if (response.ok) {
            showAlert(
              "ì„±ê³µ",
              "ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.",
              () => {
                window.location.href = '/email-login';
              }
            );
          } else {
            showMessage('error', data.message || 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
        } catch (error) {
          console.error('ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì˜¤ë¥˜:', error);
          showMessage('error', 'ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        } finally {
          // ë¡œë”© ìƒíƒœ í•´ì œ
          submitBtn.disabled = false;
          submitBtn.classList.remove('loading');
          btnText.textContent = 'Set New Password';
          showLoading(false);
        }
      }

      // ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
      function showMessage(type, message) {
        const messageElement = document.getElementById("message");
        messageElement.className = `message-area ${type}`;
        messageElement.innerHTML = message;
      }

      // ë©”ì‹œì§€ ì´ˆê¸°í™” í•¨ìˆ˜
      function clearMessage() {
        const messageElement = document.getElementById("message");
        messageElement.className = 'message-area';
        messageElement.innerHTML = '';
      }
    </script>
  </body>
</html> 