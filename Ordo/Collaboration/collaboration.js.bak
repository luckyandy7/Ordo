// ì½œë¼ë³´ë ˆì´ì…˜ ì‹¤ì‹œê°„ í˜‘ì—… ë©”ì¸ ìŠ¤í¬ë¦½íŠ¸
// ì£¼ìš” ê¸°ëŠ¥: ì›Œí¬ìŠ¤í˜ì´ìŠ¤/ì¼ì •/ì‘ì—…/íŒŒì¼/ë©¤ë²„ ê´€ë¦¬, ì‹¤ì‹œê°„ ë™ê¸°í™”, ê¶Œí•œ, ìë™ì™„ì„±, UI/ë²„íŠ¼ ì œì–´ ë“±

const socket = io({ withCredentials: true });
let currentUser = null;
let currentWorkspace = null;
let workspaceList = [];
let workspaceMembers = [];
let calendarEvents = [];
let taskList = [];
let fileList = [];
let workspaceInvitations = [];
let isAdmin = false;

// ì¸ì¦ í† í° í¬í•¨ fetch ë˜í¼
function authFetch(url, options = {}) {
  const token = localStorage.getItem('token');
  return fetch(url, {
    ...options,
    headers: {
      ...(options.headers || {}),
      'Authorization': 'Bearer ' + token,
      'Content-Type': 'application/json',
    },
    credentials: 'include',
  });
}

// ===== ì´ˆê¸°í™” =====
document.addEventListener('DOMContentLoaded', async () => {
  // ì €ì¥ëœ í…Œë§ˆ ì ìš©
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme === 'dark') {
    document.documentElement.setAttribute('data-theme', 'dark');
  } else {
    document.documentElement.removeAttribute('data-theme');
  }
  try {
    await fetchCurrentUser();
    await loadWorkspaceList();
    await loadWorkspaceInvitations();
  } catch (e) {
    console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', e);
  }

  // ëª¨ë“  ì£¼ìš” ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ìœ„ì„
  document.body.addEventListener('click', (e) => {
    // ë‹¤í¬ëª¨ë“œ í† ê¸€
    if (e.target.closest('.theme-toggle')) {
      // data-theme ì†ì„± í† ê¸€
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      if (isDark) {
        document.documentElement.removeAttribute('data-theme');
        localStorage.setItem('theme', 'light');
      } else {
        document.documentElement.setAttribute('data-theme', 'dark');
        localStorage.setItem('theme', 'dark');
      }
    }
    // ë©”ì¸ìœ¼ë¡œ ë²„íŠ¼
    if (e.target.closest('.back-button')) {
      window.location.href = '/Main/index.html';
    }
    // ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ìƒì„± ë²„íŠ¼
    if (e.target.closest('.new-workspace-btn')) {
      // ì…ë ¥ê°’ ì´ˆê¸°í™”
      const modal = document.querySelector('.workspace-modal');
      if (modal) {
        const form = modal.querySelector('form');
        if (form) {
          form.querySelector('input').value = '';
          form.querySelector('select').selectedIndex = 0;
          form.querySelector('textarea').value = '';
        }
      }
      openModal('.workspace-modal');
    }
    // ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ìƒì„± ëª¨ë‹¬ ì·¨ì†Œ
    if (e.target.closest('.modal .cancel-btn')) {
      closeAllModals();
    }
    // ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ìƒì„± ëª¨ë‹¬ ì œì¶œ (ì •í™•íˆ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ëª¨ë‹¬ ë‚´ì—ì„œë§Œ ë™ì‘)
    if (e.target.closest('.workspace-modal .submit-btn')) {
      e.preventDefault();
      const form = e.target.closest('form');
      if (!form) return;
      const name = form.querySelector('input')?.value.trim();
      const type = form.querySelector('select')?.value;
      const desc = form.querySelector('textarea')?.value.trim();
      if (!name) return alert('ì´ë¦„ ì…ë ¥');
      // ëœë¤ ì´ëª¨ì§€
      const icons = ['ğŸš€','ğŸ‘¥','ğŸ“š','ğŸ‘¤','ğŸ¦„','ğŸŒˆ','ï¿½ï¿½','ğŸ¨','ğŸ¦‰','ğŸ¦Š'];
      const icon = icons[Math.floor(Math.random()*icons.length)];
      authFetch('/api/collaboration/workspaces', {
        method:'POST',
        body:JSON.stringify({ name, type, description:desc, icon })
      }).then(async res => {
        if (res.ok) {
          closeAllModals();
          loadWorkspaceList();
        } else {
          const err = await res.json().catch(()=>({message:'ì˜¤ë¥˜'}));
          alert(err.error || err.message || 'ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ìƒì„± ì‹¤íŒ¨');
        }
      });
    }
    // ì‘ì—… ì¶”ê°€ ë²„íŠ¼
    if (e.target.closest('.task-btn')) {
      showTaskModal();
    }
    // ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì‚­ì œ(ê´€ë¦¬ìë§Œ)
    if (e.target.closest('#delete-workspace-btn')) {
      if (!isAdmin) return;
      if (!confirm('ì •ë§ ì‚­ì œ?')) return;
      authFetch(`/api/collaboration/workspaces/${currentWorkspace._id}`, { method:'DELETE' })
        .then(async res => {
          if (res.ok) loadWorkspaceList();
          else {
            const err = await res.json().catch(()=>({message:'ì˜¤ë¥˜'}));
            alert(err.error || err.message || 'ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì‚­ì œ ì‹¤íŒ¨');
          }
        });
    }
    // íƒ­ ë²„íŠ¼
    const tabBtn = e.target.closest('.tab-btn');
    if (tabBtn) {
      const tabBtns = Array.from(document.querySelectorAll('.tab-btn'));
      const idx = tabBtns.indexOf(tabBtn);
      if (idx !== -1) showTab(idx);
    }
    // ìº˜ë¦°ë” ì¶”ê°€/ë™ê¸°í™” ë²„íŠ¼
    if (e.target.closest('.calendar-btn.add')) {
      showEventModal();
    }
    if (e.target.closest('.calendar-btn.sync')) {
      loadCalendarEvents();
      alert('ìº˜ë¦°ë”ê°€ ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
    // íŒŒì¼ ì—…ë¡œë“œ ë²„íŠ¼
    if (e.target.closest('.file-btn')) {
      showFileUploadModal();
    }
    // ë©¤ë²„ ì´ˆëŒ€ ë²„íŠ¼
    if (e.target.closest('.member-btn')) {
      showInviteModal();
    }
  });

  // íŒŒì¼ ì—…ë¡œë“œ input ë™ì  ë°”ì¸ë”© (ì˜ˆì‹œ)
  document.body.addEventListener('change', (e) => {
    if (e.target.matches('.file-upload-input')) {
      // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬ í•¨ìˆ˜ í˜¸ì¶œ
      handleFileUpload(e.target.files);
    }
  });

  // ë©¤ë²„ ì´ˆëŒ€ ìë™ì™„ì„± ë“± ì¶”ê°€ ì´ë²¤íŠ¸ ìœ„ì„ í•„ìš”ì‹œ ì—¬ê¸°ì—...
});

// ===== ì‚¬ìš©ì ì •ë³´ =====
async function fetchCurrentUser() {
  try {
    const res = await authFetch('/api/user');
    if (!res.ok) throw new Error('ë¡œê·¸ì¸ í•„ìš”');
    currentUser = await res.json();
  } catch {
    alert('ë¡œê·¸ì¸ ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.');
    window.location.href = '/login';
  }
}

// ===== ì›Œí¬ìŠ¤í˜ì´ìŠ¤ =====
async function loadWorkspaceList() {
  const res = await authFetch('/api/collaboration/workspaces');
  if (!res.ok) {
    const err = await res.json().catch(()=>({message:'ì˜¤ë¥˜'}));
    alert(err.error || err.message || 'ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ëª©ë¡ ì˜¤ë¥˜');
    return;
  }
  const data = await res.json();
  workspaceList = data.workspaces || [];
  renderWorkspaceList();
  if (workspaceList.length > 0) selectWorkspace(workspaceList[0]._id);
}

function renderWorkspaceList() {
  const list = document.querySelector('.workspace-list');
  list.innerHTML = '';
  workspaceList.forEach(ws => {
    const div = document.createElement('div');
    div.className = 'workspace-item' + (currentWorkspace && ws._id === currentWorkspace._id ? ' active' : '');
    div.dataset.id = ws._id;
    // ws.iconì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ getWorkspaceAvatar(ws.type)
    div.innerHTML = `
      <div class="workspace-avatar">${ws.icon || getWorkspaceAvatar(ws.type)}</div>
      <div class="workspace-info">
        <div class="workspace-name">${ws.name}</div>
        <div class="workspace-members">${ws.members.length}ëª…</div>
      </div>
    `;
    div.onclick = () => selectWorkspace(ws._id);
    list.appendChild(div);
  });
}

function getWorkspaceAvatar(type) {
  return { project:'ğŸš€', team:'ğŸ‘¥', study:'ğŸ“š', personal:'ğŸ‘¤' }[type] || 'ğŸ“';
}

async function selectWorkspace(id) {
  currentWorkspace = workspaceList.find(w=>w._id===id);
  // isAdmin íŒë³„: members ë°°ì—´ì—ì„œ í˜„ì¬ ìœ ì €ê°€ adminì¸ì§€ í™•ì¸
  isAdmin = currentWorkspace && currentWorkspace.members.some(m => {
    // m.userëŠ” ObjectIdì´ê±°ë‚˜ ê°ì²´ì¼ ìˆ˜ ìˆìŒ
    return ((m.user && (m.user._id || m.user)) === currentUser.id) && m.role === 'admin';
  });
  renderWorkspaceList();
  renderWorkspaceHeader();
  await loadWorkspaceMembers();
  renderMemberList();
  await loadCalendarEvents();
  await loadTaskList();
  await loadFileList();
  renderRoleInSidebar();
}

function renderWorkspaceHeader() {
  document.querySelector('.workspace-avatar-large').textContent = currentWorkspace.icon || getWorkspaceAvatar(currentWorkspace.type);
  document.querySelector('.workspace-details h2').textContent = currentWorkspace.name;
  document.querySelector('.workspace-description').textContent = currentWorkspace.description || '';
  // ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì•¡ì…˜ ë²„íŠ¼ ëª¨ë‘ ì œê±° í›„(ì´ˆê¸°í™”)
  let actions = document.querySelector('.workspace-actions');
  if (actions) actions.innerHTML = '';
  // ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì‚­ì œ ë²„íŠ¼ ì¶”ê°€(ê´€ë¦¬ìë§Œ)
  if (actions && isAdmin) {
    const delBtn = document.createElement('button');
    delBtn.className = 'action-btn delete-workspace-btn';
    delBtn.title = 'ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì‚­ì œ';
    delBtn.innerHTML = 'ğŸ—‘ï¸';    delBtn.onclick = () => {
      showConfirmModal({
        title: 'ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì‚­ì œ',
        message: 'ì •ë§ ì´ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤)',
        icon: 'ğŸ—‘ï¸',
        confirmText: 'ì‚­ì œ',
        onConfirm: () => {
          authFetch(`/api/collaboration/workspaces/${currentWorkspace._id}`, { method:'DELETE' })
            .then(async res => {
              if (res.ok) loadWorkspaceList();
              else {
                const err = await res.json().catch(()=>({message:'ì˜¤ë¥˜'}));
                alert(err.error || err.message || 'ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì‚­ì œ ì‹¤íŒ¨');
              }
            });
        }
      });
    };
    actions.appendChild(delBtn);
  }
}

function renderRoleInSidebar() {
  // workspaceMembersì˜ userê°€ ê°ì²´ ë˜ëŠ” idì¼ ìˆ˜ ìˆìŒ
  const user = workspaceMembers.find(m => (m.user && (m.user._id || m.user)) === currentUser.id);
  document.querySelector('.user-name').textContent = user?.name || currentUser.name;
  document.querySelector('.user-role').textContent = user?.role === 'admin' ? 'ê´€ë¦¬ì' : 'ë©¤ë²„';
}

// ===== ê³µìœ  ìº˜ë¦°ë” =====
async function loadCalendarEvents() {
  if (!currentWorkspace) return;
  const res = await authFetch(`/api/collaboration/workspaces/${currentWorkspace._id}/events`);
  if (!res.ok) {
    const err = await res.json().catch(()=>({message:'ì˜¤ë¥˜'}));
    alert(err.error || err.message || 'ì¼ì • ëª©ë¡ ì˜¤ë¥˜');
    return;
  }
  const data = await res.json();
  calendarEvents = data.events || [];
  renderCalendarEvents();
}
function renderCalendarEvents() {
  const list = document.querySelector('.shared-events');
  list.innerHTML = '';
  calendarEvents.forEach(ev => {
    const div = document.createElement('div');
    div.className = 'event-item';
    div.innerHTML = `
      <div class="event-time">${formatEventTime(ev)}</div>
      <div class="event-content">
        <div class="event-title">${ev.title}</div>
        <div class="event-desc">${ev.description||''}</div>
      </div>
      <div class="event-status" data-status="${formatEventStatus(ev)}">${formatEventStatus(ev)}</div>
    `;
    div.onclick = () => showEventModal(ev);
    list.appendChild(div);
  });
}
function formatEventTime(ev) {
  const d1 = new Date(ev.start);
  const d2 = new Date(ev.end);
  // ì‹œê°„ ì—†ì´ ì›”/ì¼ë§Œ í‘œì‹œ
  return `${d1.getMonth()+1}/${d1.getDate()} ~ ${d2.getMonth()+1}/${d2.getDate()}`;
}
function formatEventStatus(ev) {
  return ev.status==='confirmed'?'í™•ì •':'ëŒ€ê¸°';
}

// ===== ëª¨ë‹¬ ê´€ë¦¬ =====

// ëª¨ë‹¬ ì—´ê¸°
function openModal(selector) {
  const modal = document.querySelector(selector);
  if (modal) {
    modal.classList.add('show');
    // ì²« ë²ˆì§¸ ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
    const firstInput = modal.querySelector('input[type="email"], input[type="text"], textarea');
    if (firstInput) {
      setTimeout(() => firstInput.focus(), 100);
    }
  }
}

// ëª¨ë‹¬ ë‹«ê¸°
function closeModal(selector) {
  const modal = document.querySelector(selector);
  if (modal) {
    modal.classList.remove('show');
  }
}

// ëª¨ë“  ëª¨ë‹¬ ë‹«ê¸°
function closeAllModals() {
  document.querySelectorAll('.modal').forEach(modal => {
    modal.classList.remove('show');
  });
}

// ===== ê° ì‚­ì œ ìœ í˜•ë³„ ëª¨ë‹¬ í•¨ìˆ˜ë“¤ =====

// ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì‚­ì œ ëª¨ë‹¬
function showWorkspaceDeleteModal(message, onConfirm, onCancel) {
  showConfirmModal({
    title: 'ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì‚­ì œ',
    message: message,
    icon: 'ğŸ—‘ï¸',
    confirmText: 'ì‚­ì œ',
    onConfirm: onConfirm,
    onCancel: onCancel
  });
}

// ì¼ì • ì‚­ì œ ëª¨ë‹¬
function showEventDeleteModal(message, onConfirm, onCancel) {
  showConfirmModal({
    title: 'ì¼ì • ì‚­ì œ',
    message: message,
    icon: 'ğŸ—‘ï¸',
    confirmText: 'ì‚­ì œ',
    onConfirm: onConfirm,
    onCancel: onCancel
  });
}

// ì‘ì—… ì‚­ì œ ëª¨ë‹¬
function showTaskDeleteModal(message, onConfirm, onCancel) {
  showConfirmModal({
    title: 'ì‘ì—… ì‚­ì œ',
    message: message,
    icon: 'ğŸ—‘ï¸',
    confirmText: 'ì‚­ì œ',
    onConfirm: onConfirm,
    onCancel: onCancel
  });
}

// íŒŒì¼ ì‚­ì œ ëª¨ë‹¬
function showFileDeleteModal(message, onConfirm, onCancel) {
  showConfirmModal({
    title: 'íŒŒì¼ ì‚­ì œ',
    message: message,
    icon: 'ğŸ—‘ï¸',
    confirmText: 'ì‚­ì œ',
    onConfirm: onConfirm,
    onCancel: onCancel
  });
}

// ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë‚˜ê°€ê¸° ëª¨ë‹¬
function showLeaveWorkspaceModal(message, onConfirm, onCancel) {
  showConfirmModal({
    title: 'ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë‚˜ê°€ê¸°',
    message: message,
    icon: 'ğŸšª',
    confirmText: 'ë‚˜ê°€ê¸°',
    onConfirm: onConfirm,
    onCancel: onCancel
  });
}

// ===== ëª¨ë‹¬ ìœ í‹¸(Chat ìŠ¤íƒ€ì¼) =====
function showChatStyleModal({ title, fields, onSubmit, submitText = 'í™•ì¸', cancelText = 'ì·¨ì†Œ', showDelete, onDelete }) {
  // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
  document.querySelectorAll('.modal.chat-style-modal').forEach(m=>m.remove());
  const modal = document.createElement('div');
  modal.className = 'modal chat-style-modal show';
  modal.innerHTML = `
    <div class="modal-content">
      <h3>${title}</h3>
      <form>
        ${fields.map(f => {
          if (f.type === 'select') {
            return `<div class="form-group">
              <label>${f.label}</label>
              <select name="${f.name}" ${f.required?'required':''}>
                ${f.options.map(opt => `<option value="${opt.value}"${opt.value===f.value?' selected':''}>${opt.label}</option>`).join('')}
              </select>
            </div>`;
          } else {
            return `<div class="form-group">
              <label>${f.label}</label>
              <input type="${f.type||'text'}" name="${f.name}" value="${f.value||''}" ${f.required?'required':''} ${f.disabled?'disabled':''}/>
            </div>`;
          }
        }).join('')}
        <div class="form-buttons">
          <button type="button" class="cancel-btn">${cancelText}</button>
          <button type="submit" class="submit-btn">${submitText}</button>
          ${showDelete?'<button type="button" class="delete-btn">ì‚­ì œ</button>':''}
        </div>
      </form>
    </div>
  `;
  document.body.appendChild(modal);
  modal.querySelector('.cancel-btn').onclick = () => modal.remove();
  if (showDelete && onDelete) {
    modal.querySelector('.delete-btn').onclick = () => onDelete(modal);
  }
  modal.querySelector('form').onsubmit = (e) => {
    e.preventDefault();
    const data = {};
    fields.forEach(f => {
      if (f.type === 'select') {
        data[f.name] = modal.querySelector(`[name="${f.name}"]`).value;
      } else {
        data[f.name] = modal.querySelector(`[name="${f.name}"]`).value;
      }
    });
    onSubmit(data, modal);
  };
}

// ===== ì˜ˆìœ ì‚­ì œ í™•ì¸ ëª¨ë‹¬ =====
function showConfirmModal({ title = "í™•ì¸", message, onConfirm, onCancel, icon = "â“", confirmText = "í™•ì¸", cancelText = "ì·¨ì†Œ" }) {
  // ê¸°ì¡´ confirm ëª¨ë‹¬ ì œê±°
  document.querySelectorAll('.modal.confirm-modal').forEach(m=>m.remove());
  const modal = document.createElement('div');
  modal.className = 'modal confirm-modal show';
  modal.innerHTML = `
    <div class="modal-content chat-style-modal-content">
      <div class="modal-icon" style="font-size:2.5rem;text-align:center;">${icon}</div>
      <h3 style="margin-top:12px;">${title}</h3>
      <div style="margin: 24px 0 32px 0; font-size: 1.1rem; color: #444; text-align: center;">${message}</div>
      <div class="form-buttons">
        <button type="button" class="cancel-btn">${cancelText}</button>
        <button type="button" class="delete-btn" style="background:linear-gradient(135deg, #ff6b6b, #ff4444);color:white;">${confirmText}</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  modal.querySelector('.cancel-btn').onclick = () => { modal.remove(); if (onCancel) onCancel(); };
  modal.querySelector('.delete-btn').onclick = () => { modal.remove(); if (onConfirm) onConfirm(); };
}

// ===== ê³µìœ  ìº˜ë¦°ë” ëª¨ë‹¬ ê¸°ë°˜ =====
function showEventModal(ev) {
  if (!currentWorkspace) return;
  if (!ev) {
    // ìƒˆ ì¼ì • ì¶”ê°€
    showChatStyleModal({
      title: 'ì¼ì • ì¶”ê°€',
      fields: [
        { label: 'ì œëª©', name: 'title', required: true },
        { label: 'ì„¤ëª…', name: 'description' },
        { label: 'ì‹œì‘ì¼', name: 'start', type: 'date', required: true },
        { label: 'ì¢…ë£Œì¼', name: 'end', type: 'date', required: true }
      ],
      submitText: 'ì¶”ê°€',
      onSubmit: (data, modal) => {
        authFetch(`/api/collaboration/workspaces/${currentWorkspace._id}/events`, {
          method:'POST',
          body:JSON.stringify(data)
        }).then(async res => {
          if (res.ok) { modal.remove(); loadCalendarEvents(); }
          else {
            const err = await res.json().catch(()=>({message:'ì˜¤ë¥˜'}));
            alert(err.error || err.message || 'ì¼ì • ì¶”ê°€ ì‹¤íŒ¨');
          }
        });
      }
    });
  } else {
    // ì¼ì • ìˆ˜ì •/ì‚­ì œ
    showChatStyleModal({
      title: 'ì¼ì • ìˆ˜ì •/ì‚­ì œ',
      fields: [
        { label: 'ì œëª©', name: 'title', value: ev.title, required: true },
        { label: 'ì„¤ëª…', name: 'description', value: ev.description },
        { label: 'ì‹œì‘ì¼', name: 'start', type: 'date', value: ev.start?.slice(0,10), required: true },
        { label: 'ì¢…ë£Œì¼', name: 'end', type: 'date', value: ev.end?.slice(0,10), required: true }
      ],
      submitText: 'ìˆ˜ì •',
      showDelete: true,
      onDelete: (modal) => {
        showConfirmModal({
          title: 'ì¼ì • ì‚­ì œ', message: 'ì •ë§ ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', icon: 'ï¿½ï¿½ï¸', confirmText: 'ì‚­ì œ',
          onConfirm: () => {
            authFetch(`/api/collaboration/events/${ev._id}`, { method:'DELETE' })
              .then(async res => {
                if (res.ok) { modal.remove(); loadCalendarEvents(); }
                else {
                  const err = await res.json().catch(()=>({message:'ì˜¤ë¥˜'}));
                  alert(err.error || err.message || 'ì¼ì • ì‚­ì œ ì‹¤íŒ¨');
                }
              });
          }
        });
      },
      onSubmit: (data, modal) => {
        authFetch(`/api/collaboration/events/${ev._id}`, {
          method:'PUT',
          body:JSON.stringify(data)
        }).then(async res => {
          if (res.ok) { modal.remove(); loadCalendarEvents(); }
          else {
            const err = await res.json().catch(()=>({message:'ì˜¤ë¥˜'}));
            alert(err.error || err.message || 'ì¼ì • ìˆ˜ì • ì‹¤íŒ¨');
          }
        });
      }
    });
  }
}

// ìº˜ë¦°ë” ì¶”ê°€/ë™ê¸°í™” ë²„íŠ¼ ë°”ì¸ë”©
function setupCalendarButtons() {
  const addBtn = document.querySelector('.calendar-controls .calendar-btn');
  const syncBtn = document.querySelector('.calendar-controls .calendar-btn:nth-child(2)');
  if (addBtn) addBtn.onclick = () => showEventModal();
  if (syncBtn) syncBtn.onclick = () => {
    loadCalendarEvents();
    alert('ìº˜ë¦°ë”ê°€ ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
  };
}
setupCalendarButtons();

// ===== ì‘ì—… ê´€ë¦¬ =====
async function loadTaskList() {
  if (!currentWorkspace) return;
  const res = await authFetch(`/api/collaboration/workspaces/${currentWorkspace._id}/tasks`);
  if (!res.ok) {
    const err = await res.json().catch(()=>({message:'ì˜¤ë¥˜'}));
    alert(err.error || err.message || 'ì‘ì—… ëª©ë¡ ì˜¤ë¥˜');
    return;
  }
  const data = await res.json();
  taskList = data.tasks || [];
  renderTaskList();
}
function renderTaskList() {
  // ì¹¸ë°˜ ë³´ë“œì— ìƒíƒœë³„ë¡œ ì‘ì—… ë Œë”ë§
  const columns = [
    { status: 'todo', title: 'í•  ì¼', icon: 'ğŸ“', color: 'todo' },
    { status: 'doing', title: 'ì§„í–‰ ì¤‘', icon: 'â³', color: 'doing' },
    { status: 'done', title: 'ì™„ë£Œ', icon: 'âœ…', color: 'done' }
  ];
  const board = document.querySelector('.task-board');
  if (!board) return;
  board.innerHTML = '';
  const priorityOrder = { high: 1, medium: 2, low: 3, '': 4, undefined: 4, null: 4 };
  columns.forEach(col => {
    const colDiv = document.createElement('div');
    colDiv.className = 'task-column ' + col.color;
    colDiv.innerHTML = `
      <div class="column-header">
        <h4>${col.icon} ${col.title}</h4>
        <span class="task-count">${taskList.filter(t=>t.status===col.status).length}</span>
      </div>
      <div class="task-list"></div>
    `;
    const listDiv = colDiv.querySelector('.task-list');
    // ìš°ì„ ìˆœìœ„ë³„ ì •ë ¬
    taskList
      .filter(t=>t.status===col.status)
      .sort((a, b) => (priorityOrder[a.priority]||4) - (priorityOrder[b.priority]||4))
      .forEach(task => {
        const card = document.createElement('div');
        card.className = 'task-card' + (task.status==='done'?' completed':'');
        card.innerHTML = `
          <div class="task-card-header">
            <span class="task-status-badge ${col.color}">${col.icon} ${col.title}</span>
            <span class="task-priority-badge ${task.priority||'none'}">
              ${task.priority==='high'?'ğŸ”¥ ë†’ìŒ':task.priority==='medium'?'âš¡ ë³´í†µ':task.priority==='low'?'ğŸ’§ ë‚®ìŒ':'-'}
            </span>
            <span class="task-assignee">${task.assigneeName ? 'ğŸ‘¤ ' + task.assigneeName : ''}</span>
          </div>
          <div class="task-title">${task.title}</div>
          <div class="task-desc">${task.description||''}</div>
          <div class="task-card-footer">
            <span class="task-due">${task.dueDate ? 'â° ' + task.dueDate : ''}</span>
          </div>
        `;
        card.onclick = () => showTaskModal(task);
        listDiv.appendChild(card);
      });
    board.appendChild(colDiv);
  });
}

// ===== ì‘ì—… ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ =====
function showTaskModal(task) {
  if (!currentWorkspace) return;
  if (!task) {
    // ìƒˆ ì‘ì—… ì¶”ê°€
    showChatStyleModal({
      title: 'ì‘ì—… ì¶”ê°€',
      fields: [
        { label: 'ì œëª©', name: 'title', required: true },
        { label: 'ì„¤ëª…', name: 'description' },
        { label: 'ìƒíƒœ', name: 'status', type: 'select', options: [
          { value: 'todo', label: 'í•  ì¼' },
          { value: 'doing', label: 'ì§„í–‰ ì¤‘' },
          { value: 'done', label: 'ì™„ë£Œ' }
        ], value: 'todo', required: true },
        { label: 'ìš°ì„ ìˆœìœ„', name: 'priority', type: 'select', options: [
          { value: '', label: 'ì„ íƒ' },
          { value: 'high', label: 'ë†’ìŒ' },
          { value: 'medium', label: 'ë³´í†µ' },
          { value: 'low', label: 'ë‚®ìŒ' }
        ], value: '', required: false }
      ],
      submitText: 'ì¶”ê°€',
      onSubmit: (data, modal) => {
        if (!['todo','doing','done'].includes(data.status)) return alert('ìƒíƒœëŠ” todo/doing/done ì¤‘ í•˜ë‚˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
        authFetch(`/api/collaboration/workspaces/${currentWorkspace._id}/tasks`, {
          method:'POST',
          body:JSON.stringify(data)
        }).then(async res => {
          if (res.ok) { modal.remove(); loadTaskList(); }
          else {
            const err = await res.json().catch(()=>({message:'ì˜¤ë¥˜'}));
            alert(err.error || err.message || 'ì‘ì—… ì¶”ê°€ ì‹¤íŒ¨');
          }
        });
      }
    });
  } else {
    // ì‘ì—… ìˆ˜ì •/ì‚­ì œ
    showChatStyleModal({
      title: 'ì‘ì—… ìˆ˜ì •/ì‚­ì œ',
      fields: [
        { label: 'ì œëª©', name: 'title', value: task.title, required: true },
        { label: 'ì„¤ëª…', name: 'description', value: task.description },
        { label: 'ìƒíƒœ', name: 'status', type: 'select', options: [
          { value: 'todo', label: 'í•  ì¼' },
          { value: 'doing', label: 'ì§„í–‰ ì¤‘' },
          { value: 'done', label: 'ì™„ë£Œ' }
        ], value: task.status, required: true },
        { label: 'ìš°ì„ ìˆœìœ„', name: 'priority', type: 'select', options: [
          { value: '', label: 'ì„ íƒ' },
          { value: 'high', label: 'ë†’ìŒ' },
          { value: 'medium', label: 'ë³´í†µ' },
          { value: 'low', label: 'ë‚®ìŒ' }
        ], value: task.priority||'', required: false }
      ],
      submitText: 'ìˆ˜ì •',
      showDelete: true,
      onDelete: (modal) => {
        showConfirmModal({
          title: 'ì‘ì—… ì‚­ì œ', message: 'ì •ë§ ì´ ì‘ì—…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', icon: 'ğŸ—‘ï¸', confirmText: 'ì‚­ì œ',
          onConfirm: () => {
            authFetch(`/api/collaboration/tasks/${task._id}`, { method:'DELETE' })
              .then(async res => {
                if (res.ok) { modal.remove(); loadTaskList(); }
                else {
                  const err = await res.json().catch(()=>({message:'ì˜¤ë¥˜'}));
                  alert(err.error || err.message || 'ì‘ì—… ì‚­ì œ ì‹¤íŒ¨');
                }
              });
          }
        });
      },
      onSubmit: (data, modal) => {
        if (!['todo','doing','done'].includes(data.status)) return alert('ìƒíƒœëŠ” todo/doing/done ì¤‘ í•˜ë‚˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
        authFetch(`/api/collaboration/tasks/${task._id}`, {
          method:'PUT',
          body:JSON.stringify(data)
        }).then(async res => {
          if (res.ok) { modal.remove(); loadTaskList(); }
          else {
            const err = await res.json().catch(()=>({message:'ì˜¤ë¥˜'}));
            alert(err.error || err.message || 'ì‘ì—… ìˆ˜ì • ì‹¤íŒ¨');
          }
        });
      }
    });
  }
}

// ì‘ì—… ì¶”ê°€ ë²„íŠ¼ ë°”ì¸ë”©
function setupTaskButton() {
  const addBtn = document.querySelector('.tasks-header .task-btn');
  if (addBtn) addBtn.onclick = () => showTaskModal();
}
setupTaskButton();

// ===== íŒŒì¼ ê³µìœ  =====
async function loadFileList() {
  if (!currentWorkspace) return;
  const res = await authFetch(`/api/collaboration/workspaces/${currentWorkspace._id}/files`);
  if (!res.ok) {
    const err = await res.json().catch(()=>({message:'ì˜¤ë¥˜'}));
    alert(err.error || err.message || 'íŒŒì¼ ëª©ë¡ ì˜¤ë¥˜');
    return;
  }
  const data = await res.json();
  fileList = data.files || [];
  renderFileList();
}
function renderFileList() {
  const list = document.querySelector('.file-list');
  if (!list) return;
  list.innerHTML = '';
  fileList.forEach(file => {
    const size = file.readableSize || (file.size ? formatFileSize(file.size) : '');
    const div = document.createElement('div');
    div.className = 'file-item';
    div.innerHTML = `
      <div class="file-icon">ğŸ“„</div>
      <div class="file-info">
        <div class="file-name">${file.originalName}</div>
        <div class="file-meta">${file.uploaderName||''} â€¢ ${size}</div>
      </div>
      <div class="file-actions">
        <button class="file-action-btn" title="ë‹¤ìš´ë¡œë“œ">â¬‡ï¸</button>
        ${file.uploader===currentUser.id?'<button class="file-action-btn" title="ì‚­ì œ">ğŸ—‘ï¸</button>':''}
      </div>
    `;
    // ë‹¤ìš´ë¡œë“œ/ì‚­ì œ ë²„íŠ¼ ë°”ì¸ë”©
    div.querySelector('.file-action-btn[title="ë‹¤ìš´ë¡œë“œ"]').onclick = (e) => {
      e.stopPropagation();
      downloadFile(file);
    };
    if (file.uploader===currentUser.id) {
      div.querySelector('.file-action-btn[title="ì‚­ì œ"]').onclick = (e) => {
        e.stopPropagation();
        showConfirmModal({
          message: 'ì •ë§ ì´ íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
          onConfirm: () => deleteFile(file)
        });
      };
    }
    list.appendChild(div);
  });
}
function formatFileSize(size) {
  if (!size) return '';
  const units = ['B','KB','MB','GB'];
  let i = 0;
  let s = size;
  while (s >= 1024 && i < units.length-1) { s /= 1024; i++; }
  return (Math.round(s*100)/100) + ' ' + units[i];
}
function downloadFile(file) {
  // ì¸ì¦ í† í°ì„ í¬í•¨í•œ URL ìƒì„±
  const token = localStorage.getItem('token');
  const url = `/api/collaboration/files/${file._id}/download`;
  
  console.log("[í´ë¼ì´ì–¸íŠ¸ ë¡œê·¸] íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹œë„:", file._id);
  
  // ìƒˆ ì°½ì—ì„œ ë‹¤ìš´ë¡œë“œ ì‹œì‘
  const downloadWindow = window.open('', '_blank');
  if (!downloadWindow) {
    alert('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. íŒì—… ì°¨ë‹¨ì„ í•´ì œí•´ì£¼ì„¸ìš”.');
    return;
  }

  // ì¸ì¦ í† í°ì„ í¬í•¨í•˜ì—¬ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ìš”ì²­
  fetch(url, {
    headers: {
      'Authorization': 'Bearer ' + token
    }
  }).then(response => {
    console.log("[í´ë¼ì´ì–¸íŠ¸ ë¡œê·¸] ë‹¤ìš´ë¡œë“œ ì‘ë‹µ ìƒíƒœ:", response.status);
    if (!response.ok) {
      throw new Error(`íŒŒì¼ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (${response.status})`);
    }
    return response.blob();
  }).then(blob => {
    // Blob URL ìƒì„± ë° ë‹¤ìš´ë¡œë“œ ë§í¬ í´ë¦­
    const blobUrl = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = blobUrl;
    a.download = file.originalName || file.filename;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(blobUrl);
    document.body.removeChild(a);
    downloadWindow.close();
  }).catch(error => {
    console.error("[í´ë¼ì´ì–¸íŠ¸ ë¡œê·¸] íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì—ëŸ¬:", error);
    alert(error.message || 'íŒŒì¼ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    downloadWindow.close();
  });
}
function deleteFile(file) {
  authFetch(`/api/collaboration/files/${file._id}`, { method:'DELETE' })
    .then(async res => {
      if (res.ok) {
        loadFileList();
      } else {
        const err = await res.json().catch(()=>({message:'ì˜¤ë¥˜'}));
        alert(err.error || err.message || 'íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨');
      }
    });
}

// ===== ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë©¤ë²„ ë¡œë“œ =====
async function loadWorkspaceMembers() {
  if (!currentWorkspace) return;
  const res = await authFetch(`/api/collaboration/workspaces/${currentWorkspace._id}/members`);
  if (!res.ok) {
    const err = await res.json().catch(()=>({message:'ì˜¤ë¥˜'}));
    alert(err.error || err.message || 'ë©¤ë²„ ëª©ë¡ ì˜¤ë¥˜');
    return;
  }
  const data = await res.json();
  workspaceMembers = data.members || [];
}

// ===== ë©¤ë²„ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ =====
function renderMemberList() {
  const list = document.querySelector('.member-list');
  if (!list) return;
  list.innerHTML = '';
  
  // í˜„ì¬ ì‚¬ìš©ìì˜ ë©¤ë²„ ì •ë³´ ì°¾ê¸°
  const currentMember = workspaceMembers.find(m => 
    (m.user && (m.user._id || m.user)) === currentUser.id
  );
  
  // ë‚˜ê°€ê¸° ë²„íŠ¼ ì¶”ê°€
  list.innerHTML = `
    <div class="member-item leave-workspace">
      <button class="leave-workspace-btn" onclick="showLeaveWorkspaceConfirm()">
        ì´ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë‚˜ê°€ê¸°
      </button>
    </div>
  `;
  
  // ë©¤ë²„ ëª©ë¡ ë Œë”ë§
  workspaceMembers.forEach(m => {
    // m.userëŠ” ê°ì²´ ë˜ëŠ” idì¼ ìˆ˜ ìˆìŒ
    const user = typeof m.user === 'object' ? m.user : { name: 'ì•Œ ìˆ˜ ì—†ìŒ', email: '' };
    const role = m.role === 'admin' ? 'ê´€ë¦¬ì' : 'ë©¤ë²„';
    list.innerHTML += `
      <div class="member-item">
        <div class="member-avatar">ğŸ‘¤</div>
        <div class="member-info">
          <div class="member-name">${user.name || ''}</div>
          <div class="member-email">${user.email || ''}</div>
        </div>
        <div class="member-role ${m.role}">${role}</div>
      </div>
    `;
  });
}

// ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë‚˜ê°€ê¸° í™•ì¸ ëª¨ë‹¬
function showLeaveWorkspaceConfirm() {  showConfirmModal({
    title: 'ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë‚˜ê°€ê¸°',
    message: 'ì •ë§ë¡œ ì´ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ë¥¼ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?<br>ë‚˜ê°€ì‹œë©´ ë‹¤ì‹œ ì´ˆëŒ€ë¥¼ ë°›ì•„ì•¼ í•©ë‹ˆë‹¤.',
    icon: 'ğŸšª',
    confirmText: 'ë‚˜ê°€ê¸°',
    onConfirm: async () => {
      try {
        const res = await authFetch(`/api/collaboration/workspaces/${currentWorkspace._id}/leave`, {
          method: 'POST'
        });
        
        const data = await res.json();
        if (res.ok) {
          alert('ì›Œí¬ìŠ¤í˜ì´ìŠ¤ë¥¼ ë‚˜ê°”ìŠµë‹ˆë‹¤.');
          // ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          await loadWorkspaceList();
        } else {
          throw new Error(data.error || 'ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë‚˜ê°€ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (error) {
        alert(error.message);
      }
    }
  });
}

// ===== ë‹¤í¬ëª¨ë“œ í† ê¸€ =====
// function setupThemeToggle() {
//   const btn = document.querySelector('.theme-toggle');
//   if (!btn) return;
//   btn.onclick = () => {
//     document.body.classList.toggle('dark');
//     // í•„ìš”ì‹œ localStorage ë“±ì— ì €ì¥ ê°€ëŠ¥
//   };
// }

// ===== íƒ­ ì „í™˜ í•¨ìˆ˜ =====
function showTab(idx) {
  const tabBtns = document.querySelectorAll('.tab-btn');
  const tabPanes = document.querySelectorAll('.tab-pane');
  if (!tabBtns || !tabPanes) return;
  tabBtns.forEach((b,i)=>b.classList.toggle('active',i===idx));
  tabPanes.forEach((p,i)=>p.classList.toggle('active',i===idx));
}

// ===== ê³µìœ  ìº˜ë¦°ë” ëª¨ë‹¬ ê¸°ë°˜ =====
function showEventModal(ev) {
  if (!currentWorkspace) return;
  if (!ev) {
    // ìƒˆ ì¼ì • ì¶”ê°€
    showChatStyleModal({
      title: 'ì¼ì • ì¶”ê°€',
      fields: [
        { label: 'ì œëª©', name: 'title', required: true },
        { label: 'ì„¤ëª…', name: 'description' },
        { label: 'ì‹œì‘ì¼', name: 'start', type: 'date', required: true },
        { label: 'ì¢…ë£Œì¼', name: 'end', type: 'date', required: true }
      ],
      submitText: 'ì¶”ê°€',
      onSubmit: (data, modal) => {
        authFetch(`/api/collaboration/workspaces/${currentWorkspace._id}/events`, {
          method:'POST',
          body:JSON.stringify(data)
        }).then(async res => {
          if (res.ok) { modal.remove(); loadCalendarEvents(); }
          else {
            const err = await res.json().catch(()=>({message:'ì˜¤ë¥˜'}));
            alert(err.error || err.message || 'ì¼ì • ì¶”ê°€ ì‹¤íŒ¨');
          }
        });
      }
    });
  } else {
    // ì¼ì • ìˆ˜ì •/ì‚­ì œ
    showChatStyleModal({
      title: 'ì¼ì • ìˆ˜ì •/ì‚­ì œ',
      fields: [
        { label: 'ì œëª©', name: 'title', value: ev.title, required: true },
        { label: 'ì„¤ëª…', name: 'description', value: ev.description },
        { label: 'ì‹œì‘ì¼', name: 'start', type: 'date', value: ev.start?.slice(0,10), required: true },
        { label: 'ì¢…ë£Œì¼', name: 'end', type: 'date', value: ev.end?.slice(0,10), required: true }
      ],
      submitText: 'ìˆ˜ì •',
      showDelete: true,
      onDelete: (modal) => {
        showConfirmModal({
          title: 'ì¼ì • ì‚­ì œ', message: 'ì •ë§ ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', icon: 'ï¿½ï¿½ï¸', confirmText: 'ì‚­ì œ',
          onConfirm: () => {
            authFetch(`/api/collaboration/events/${ev._id}`, { method:'DELETE' })
              .then(async res => {
                if (res.ok) { modal.remove(); loadCalendarEvents(); }
                else {
                  const err = await res.json().catch(()=>({message:'ì˜¤ë¥˜'}));
                  alert(err.error || err.message || 'ì¼ì • ì‚­ì œ ì‹¤íŒ¨');
                }
              });
          }
        });
      },
      onSubmit: (data, modal) => {
        authFetch(`/api/collaboration/events/${ev._id}`, {
          method:'PUT',
          body:JSON.stringify(data)
        }).then(async res => {
          if (res.ok) { modal.remove(); loadCalendarEvents(); }
          else {
            const err = await res.json().catch(()=>({message:'ì˜¤ë¥˜'}));
            alert(err.error || err.message || 'ì¼ì • ìˆ˜ì • ì‹¤íŒ¨');
          }
        });
      }
    });
  }
}

// ===== Socket.IO ì´ë²¤íŠ¸ =====

// ì‹¤ì‹œê°„ ì´ˆëŒ€ ì•Œë¦¼ ìˆ˜ì‹ 
socket.on('new_workspace_invitation', (data) => {
  const { invitation } = data;
  
  // ì´ˆëŒ€ ëª©ë¡ì— ì¶”ê°€
  workspaceInvitations.unshift(invitation);
  updateInvitationsUI();
  
  // ì•Œë¦¼ í‘œì‹œ
  showNotification(`${invitation.workspace.name} ì›Œí¬ìŠ¤í˜ì´ìŠ¤ì— ì´ˆëŒ€ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'info');
});

// ì´ˆëŒ€ ìƒíƒœ ë³€ê²½ ì•Œë¦¼
socket.on('invitation_responded', (data) => {
  const { invitationId, status, workspaceName, userName } = data;
  
  if (status === 'accepted') {
    showNotification(`${userName}ë‹˜ì´ ${workspaceName} ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì´ˆëŒ€ë¥¼ ìˆ˜ë½í–ˆìŠµë‹ˆë‹¤.`, 'success');
    // ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë©¤ë²„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    if (currentWorkspace) {
      loadWorkspaceMembers(currentWorkspace._id);
    }
  } else if (status === 'declined') {
    showNotification(`${userName}ë‹˜ì´ ${workspaceName} ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì´ˆëŒ€ë¥¼ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤.`, 'info');
  }
});

// ===== ê³µìœ  ìº˜ë¦°ë” ëª¨ë‹¬ ê¸°ë°˜ =====
function showEventModal(ev) {
  if (!currentWorkspace) return;
  if (!ev) {
    // ìƒˆ ì¼ì • ì¶”ê°€
    showChatStyleModal({
      title: 'ì¼ì • ì¶”ê°€',
      fields: [
        { label: 'ì œëª©', name: 'title', required: true },
        { label: 'ì„¤ëª…', name: 'description' },
        { label: 'ì‹œì‘ì¼', name: 'start', type: 'date', required: true },
        { label: 'ì¢…ë£Œì¼', name: 'end', type: 'date', required: true }
      ],
      submitText: 'ì¶”ê°€',
      onSubmit: (data, modal) => {
        authFetch(`/api/collaboration/workspaces/${currentWorkspace._id}/events`, {
          method:'POST',
          body:JSON.stringify(data)
        }).then(async res => {
          if (res.ok) { modal.remove(); loadCalendarEvents(); }
          else {
            const err = await res.json().catch(()=>({message:'ì˜¤ë¥˜'}));
            alert(err.error || err.message || 'ì¼ì • ì¶”ê°€ ì‹¤íŒ¨');
          }
        });
      }
    });
  } else {
    // ì¼ì • ìˆ˜ì •/ì‚­ì œ
    showChatStyleModal({
      title: 'ì¼ì • ìˆ˜ì •/ì‚­ì œ',
      fields: [
        { label: 'ì œëª©', name: 'title', value: ev.title, required: true },
        { label: 'ì„¤ëª…', name: 'description', value: ev.description },
        { label: 'ì‹œì‘ì¼', name: 'start', type: 'date', value: ev.start?.slice(0,10), required: true },
        { label: 'ì¢…ë£Œì¼', name: 'end', type: 'date', value: ev.end?.slice(0,10), required: true }
      ],
      submitText: 'ìˆ˜ì •',
      showDelete: true,
      onDelete: (modal) => {
        showConfirmModal({
          title: 'ì¼ì • ì‚­ì œ', message: 'ì •ë§ ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', icon: 'ğŸ—‘ï¸', confirmText: 'ì‚­ì œ',
          onConfirm: () => {
            authFetch(`/api/collaboration/events/${ev._id}`, { method:'DELETE' })
              .then(async res => {
                if (res.ok) { modal.remove(); loadCalendarEvents(); }
                else {
                  const err = await res.json().catch(()=>({message:'ì˜¤ë¥˜'}));
                  alert(err.error || err.message || 'ì¼ì • ì‚­ì œ ì‹¤íŒ¨');
                }
              });
          }
        });
      },
      onSubmit: (data, modal) => {
        authFetch(`/api/collaboration/events/${ev._id}`, {
          method:'PUT',
          body:JSON.stringify(data)
        }).then(async res => {
          if (res.ok) { modal.remove(); loadCalendarEvents(); }
          else {
            const err = await res.json().catch(()=>({message:'ì˜¤ë¥˜'}));
            alert(err.error || err.message || 'ì¼ì • ìˆ˜ì • ì‹¤íŒ¨');
          }
        });
      }
    });
  }
}

// ===== ì‘ì—… ê´€ë¦¬ =====
async function loadTaskList() {
  if (!currentWorkspace) return;
  const res = await authFetch(`/api/collaboration/workspaces/${currentWorkspace._id}/tasks`);
  if (!res.ok) {
    const err = await res.json().catch(()=>({message:'ì˜¤ë¥˜'}));
    alert(err.error || err.message || 'ì‘ì—… ëª©ë¡ ì˜¤ë¥˜');
    return;
  }
  const data = await res.json();
  taskList = data.tasks || [];
  renderTaskList();
}
function renderTaskList() {
  // ì¹¸ë°˜ ë³´ë“œì— ìƒíƒœë³„ë¡œ ì‘ì—… ë Œë”ë§
  const columns = [
    { status: 'todo', title: 'í•  ì¼', icon: 'ğŸ“', color: 'todo' },
    { status: 'doing', title: 'ì§„í–‰ ì¤‘', icon: 'â³', color: 'doing' },
    { status: 'done', title: 'ì™„ë£Œ', icon: 'âœ…', color: 'done' }
  ];
  const board = document.querySelector('.task-board');
  if (!board) return;
  board.innerHTML = '';
  const priorityOrder = { high: 1, medium: 2, low: 3, '': 4, undefined: 4, null: 4 };
  columns.forEach(col => {
    const colDiv = document.createElement('div');
    colDiv.className = 'task-column ' + col.color;
    colDiv.innerHTML = `
      <div class="column-header">
        <h4>${col.icon} ${col.title}</h4>
        <span class="task-count">${taskList.filter(t=>t.status===col.status).length}</span>
      </div>
      <div class="task-list"></div>
    `;
    const listDiv = colDiv.querySelector('.task-list');
    // ìš°ì„ ìˆœìœ„ë³„ ì •ë ¬
    taskList
      .filter(t=>t.status===col.status)
      .sort((a, b) => (priorityOrder[a.priority]||4) - (priorityOrder[b.priority]||4))
      .forEach(task => {
        const card = document.createElement('div');
        card.className = 'task-card' + (task.status==='done'?' completed':'');
        card.innerHTML = `
          <div class="task-card-header">
            <span class="task-status-badge ${col.color}">${col.icon} ${col.title}</span>
            <span class="task-priority-badge ${task.priority||'none'}">
              ${task.priority==='high'?'ğŸ”¥ ë†’ìŒ':task.priority==='medium'?'âš¡ ë³´í†µ':task.priority==='low'?'ğŸ’§ ë‚®ìŒ':'-'}
            </span>
            <span class="task-assignee">${task.assigneeName ? 'ğŸ‘¤ ' + task.assigneeName : ''}</span>
          </div>
          <div class="task-title">${task.title}</div>
          <div class="task-desc">${task.description||''}</div>
          <div class="task-card-footer">
            <span class="task-due">${task.dueDate ? 'â° ' + task.dueDate : ''}</span>
          </div>
        `;
        card.onclick = () => showTaskModal(task);
        listDiv.appendChild(card);
      });
    board.appendChild(colDiv);
  });
}

// ===== ì‘ì—… ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ =====
function showTaskModal(task) {
  if (!currentWorkspace) return;
  if (!task) {
    // ìƒˆ ì‘ì—… ì¶”ê°€
    showChatStyleModal({
      title: 'ì‘ì—… ì¶”ê°€',
      fields: [
        { label: 'ì œëª©', name: 'title', required: true },
        { label: 'ì„¤ëª…', name: 'description' },
        { label: 'ìƒíƒœ', name: 'status', type: 'select', options: [
          { value: 'todo', label: 'í•  ì¼' },
          { value: 'doing', label: 'ì§„í–‰ ì¤‘' },
          { value: 'done', label: 'ì™„ë£Œ' }
        ], value: 'todo', required: true },
        { label: 'ìš°ì„ ìˆœìœ„', name: 'priority', type: 'select', options: [
          { value: '', label: 'ì„ íƒ' },
          { value: 'high', label: 'ë†’ìŒ' },
          { value: 'medium', label: 'ë³´í†µ' },
          { value: 'low', label: 'ë‚®ìŒ' }
        ], value: '', required: false }
      ],
      submitText: 'ì¶”ê°€',
      onSubmit: (data, modal) => {
        if (!['todo','doing','done'].includes(data.status)) return alert('ìƒíƒœëŠ” todo/doing/done ì¤‘ í•˜ë‚˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
        authFetch(`/api/collaboration/workspaces/${currentWorkspace._id}/tasks`, {
          method:'POST',
          body:JSON.stringify(data)
        }).then(async res => {
          if (res.ok) { modal.remove(); loadTaskList(); }
          else {
            const err = await res.json().catch(()=>({message:'ì˜¤ë¥˜'}));
            alert(err.error || err.message || 'ì‘ì—… ì¶”ê°€ ì‹¤íŒ¨');
          }
        });
      }
    });
  } else {
    // ì‘ì—… ìˆ˜ì •/ì‚­ì œ
    showChatStyleModal({
      title: 'ì‘ì—… ìˆ˜ì •/ì‚­ì œ',
      fields: [
        { label: 'ì œëª©', name: 'title', value: task.title, required: true },
        { label: 'ì„¤ëª…', name: 'description', value: task.description },
        { label: 'ìƒíƒœ', name: 'status', type: 'select', options: [
          { value: 'todo', label: 'í•  ì¼' },
          { value: 'doing', label: 'ì§„í–‰ ì¤‘' },
          { value: 'done', label: 'ì™„ë£Œ' }
        ], value: task.status, required: true },
        { label: 'ìš°ì„ ìˆœìœ„', name: 'priority', type: 'select', options: [
          { value: '', label: 'ì„ íƒ' },
          { value: 'high', label: 'ë†’ìŒ' },
          { value: 'medium', label: 'ë³´í†µ' },
          { value: 'low', label: 'ë‚®ìŒ' }
        ], value: task.priority||'', required: false }
      ],
      submitText: 'ìˆ˜ì •',
      showDelete: true,
      onDelete: (modal) => {
        showConfirmModal({
          message: 'ì •ë§ ì´ ì‘ì—…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
          onConfirm: () => {
            authFetch(`/api/collaboration/tasks/${task._id}`, { method:'DELETE' })
              .then(async res => {
                if (res.ok) { modal.remove(); loadTaskList(); }
                else {
                  const err = await res.json().catch(()=>({message:'ì˜¤ë¥˜'}));
                  alert(err.error || err.message || 'ì‘ì—… ì‚­ì œ ì‹¤íŒ¨');
                }
              });
          }
        });
      },
      onSubmit: (data, modal) => {
        if (!['todo','doing','done'].includes(data.status)) return alert('ìƒíƒœëŠ” todo/doing/done ì¤‘ í•˜ë‚˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
        authFetch(`/api/collaboration/tasks/${task._id}`, {
          method:'PUT',
          body:JSON.stringify(data)
        }).then(async res => {
          if (res.ok) { modal.remove(); loadTaskList(); }
          else {
            const err = await res.json().catch(()=>({message:'ì˜¤ë¥˜'}));
            alert(err.error || err.message || 'ì‘ì—… ìˆ˜ì • ì‹¤íŒ¨');
          }
        });
      }
    });
  }
}

// íŒŒì¼ ì—…ë¡œë“œ ëª¨ë‹¬ í•¨ìˆ˜
function showFileUploadModal() {
  showChatStyleModal({
    title: 'íŒŒì¼ ì—…ë¡œë“œ',
    fields: [
      { label: 'íŒŒì¼', name: 'file', type: 'file', required: true }
    ],
    submitText: 'ì—…ë¡œë“œ',
    onSubmit: (data, modal) => {
      const fileInput = document.querySelector('.chat-style-modal input[type="file"]');
      if (!fileInput || !fileInput.files[0]) return alert('íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.');
      const formData = new FormData();
      formData.append('file', fileInput.files[0]);
      
      // íŒŒì¼ ì—…ë¡œë“œ ìš”ì²­ì€ ì¼ë°˜ fetch ì‚¬ìš© (authFetchëŠ” Content-Type: application/jsonì„ ìë™ìœ¼ë¡œ ì¶”ê°€í•¨)
      fetch(`/api/collaboration/workspaces/${currentWorkspace._id}/files`, {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: formData
      }).then(async res => {
        if (res.ok) { 
          modal.remove(); 
          loadFileList(); 
        } else {
          const err = await res.json().catch(()=>({message:'ì˜¤ë¥˜'}));
          alert(err.error || err.message || 'íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨');
        }
      });
    }
  });
}

// ë©¤ë²„ ì´ˆëŒ€ ëª¨ë‹¬ í•¨ìˆ˜
function showInviteModal() {
  showChatStyleModal({
    title: 'ë©¤ë²„ ì´ˆëŒ€',
    fields: [
      { label: 'ì´ë©”ì¼', name: 'email', type: 'email', required: true },
      { label: 'ê¶Œí•œ', name: 'role', type: 'select', options: [
        { value: 'member', label: 'ë©¤ë²„' },
        { value: 'admin', label: 'ê´€ë¦¬ì' }
      ], value: 'member', required: true }
    ],
    submitText: 'ì´ˆëŒ€',
    onSubmit: (data, modal) => {
      authFetch(`/api/collaboration/workspaces/${currentWorkspace._id}/invite`, {
        method: 'POST',
        body: JSON.stringify(data)
      }).then(async res => {
        if (res.ok) { modal.remove(); loadWorkspaceMembers(); renderMemberList(); }
        else {
          const err = await res.json().catch(()=>({message:'ì˜¤ë¥˜'}));
          alert(err.error || err.message || 'ë©¤ë²„ ì´ˆëŒ€ ì‹¤íŒ¨');
        }
      });
    }
  });

  // ===== ìë™ì™„ì„± ê¸°ëŠ¥ ì¶”ê°€ =====
  setTimeout(() => {
    const modal = document.querySelector('.chat-style-modal');
    const input = modal && modal.querySelector('input[name="email"]');
    if (!input) return;
    let suggestBox = document.createElement('div');
    suggestBox.className = 'autocomplete-suggest-box';
    suggestBox.style.position = 'absolute';
    suggestBox.style.zIndex = 1000;
    suggestBox.style.background = '#fff';
    suggestBox.style.border = '1px solid #ccc';
    suggestBox.style.width = input.offsetWidth + 'px';
    suggestBox.style.maxHeight = '180px';
    suggestBox.style.overflowY = 'auto';
    suggestBox.style.display = 'none';
    input.parentNode.appendChild(suggestBox);

    let lastQuery = '';
    input.addEventListener('input', async function() {
      const q = input.value.trim();
      if (q.length < 2) { suggestBox.style.display = 'none'; return; }
      if (q === lastQuery) return;
      lastQuery = q;
      const res = await authFetch(`/api/collaboration/users/search?q=${encodeURIComponent(q)}`);
      if (!res.ok) { suggestBox.style.display = 'none'; return; }
      const data = await res.json();
      if (!data.users || !data.users.length) { suggestBox.style.display = 'none'; return; }
      suggestBox.innerHTML = data.users.map(u => `<div class='suggest-item' style='padding:6px 12px;cursor:pointer;'>${u.name} <span style='color:#888;font-size:12px;'>${u.email}</span></div>`).join('');
      suggestBox.style.display = 'block';
      Array.from(suggestBox.children).forEach((item, idx) => {
        item.onclick = () => {
          input.value = data.users[idx].email;
          suggestBox.style.display = 'none';
        };
      });
    });
    input.addEventListener('blur', () => setTimeout(()=>{suggestBox.style.display='none';}, 200));
  }, 100);
}

// ===== ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì´ˆëŒ€ ê´€ë¦¬ =====

// ë°›ì€ ì´ˆëŒ€ ëª©ë¡ ë¡œë“œ
async function loadWorkspaceInvitations() {
  try {
    const response = await authFetch('/api/collaboration/invitations/received');
    const result = await response.json();
    
    if (result.status === 'success') {
      workspaceInvitations = result.data.invitations || [];
      updateInvitationsUI();
    } else {
      console.error('ì´ˆëŒ€ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', result.message);
    }
  } catch (error) {
    console.error('ì´ˆëŒ€ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
  }
}

// ì´ˆëŒ€ UI ì—…ë°ì´íŠ¸
function updateInvitationsUI() {
  const invitationsList = document.querySelector('.invitations-list');
  const invitationCount = document.querySelector('.invitation-count');
  
  if (!invitationsList || !invitationCount) return;
  
  // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
  invitationCount.textContent = workspaceInvitations.length;
  
  // ì´ˆëŒ€ê°€ ì—†ëŠ” ê²½ìš°
  if (workspaceInvitations.length === 0) {
    invitationsList.innerHTML = '<div class="no-invitations">ë°›ì€ ì´ˆëŒ€ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
    return;
  }
  
  // ì´ˆëŒ€ ëª©ë¡ ë Œë”ë§
  invitationsList.innerHTML = workspaceInvitations.map(invitation => `
    <div class="invitation-card" data-id="${invitation._id}">
      <div class="invitation-header">
        <div class="invitation-workspace-name">
          <span class="invitation-workspace-icon">ğŸ¢</span>
          ${invitation.workspace.name}
        </div>
        <div class="invitation-inviter">
          ${invitation.inviter.name}ë‹˜ì´ ì´ˆëŒ€
        </div>
      </div>
      ${invitation.message ? `<div class="invitation-message">"${invitation.message}"</div>` : ''}
      <div class="invitation-actions">
        <button class="invitation-btn accept-btn" onclick="respondToInvitation('${invitation._id}', 'accepted')">
          ìˆ˜ë½
        </button>
        <button class="invitation-btn decline-btn" onclick="respondToInvitation('${invitation._id}', 'declined')">
          ê±°ì ˆ
        </button>
      </div>
    </div>
  `).join('');
}

// ì´ˆëŒ€ ì‘ë‹µ (ìˆ˜ë½/ê±°ì ˆ)
async function respondToInvitation(invitationId, response) {
  try {
    const result = await authFetch(`/api/collaboration/invitations/${invitationId}`, {
      method: 'PUT',
      body: JSON.stringify({ status: response })
    });
    
    const data = await result.json();
    
    if (data.status === 'success') {
      // ì´ˆëŒ€ ëª©ë¡ì—ì„œ ì œê±°
      workspaceInvitations = workspaceInvitations.filter(inv => inv._id !== invitationId);
      updateInvitationsUI();
      
      if (response === 'accepted') {
        // ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        await loadWorkspaceList();
        showNotification('ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì´ˆëŒ€ë¥¼ ìˆ˜ë½í–ˆìŠµë‹ˆë‹¤!', 'success');
      } else {
        showNotification('ì´ˆëŒ€ë¥¼ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤.', 'info');
      }
    } else {
      showNotification(data.message || 'ì´ˆëŒ€ ì‘ë‹µì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
  } catch (error) {
    console.error('ì´ˆëŒ€ ì‘ë‹µ ì˜¤ë¥˜:', error);
    showNotification('ì´ˆëŒ€ ì‘ë‹µ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
  }
}

// ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì´ˆëŒ€ ë³´ë‚´ê¸°
async function sendWorkspaceInvitation(workspaceId, email, role = 'member', message = '') {
  try {
    const response = await authFetch(`/api/collaboration/workspaces/${workspaceId}/invitations`, {
      method: 'POST',
      body: JSON.stringify({ email, role, message })
    });
    
    const result = await response.json();
    
    if (response.ok) {
      showNotification('ì´ˆëŒ€ê°€ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
      return result;
    } else {
      throw new Error(result.error || 'ì´ˆëŒ€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  } catch (error) {
    console.error('ì´ˆëŒ€ ì „ì†¡ ì˜¤ë¥˜:', error);
    showNotification(error.message || 'ì´ˆëŒ€ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    throw error;
  }
}

// ëª¨ë“  ëª¨ë‹¬ ë‹«ê¸°
function closeAllModals() {
  document.querySelectorAll('.modal').forEach(modal => {
    modal.classList.remove('show');
  });
}